<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>ProxySQL之连接复用（multiplexing）以及相关问题说明 | Sean&#39;s Note</title>
<meta name="keywords" content="mysql, 中间件, proxysql">
<meta name="description" content="ProxySQL在连接池(persistent connection poll)的基础上，还有一个连接复用的概念 multiplexing connection，官方的wiki里没有很明确的说明，但在作者的一些 blog post 和 issue 里能找到解答： https://github.com/sysown/proxysql/issues/939#issuecomment-287489317">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/2017/04/mysql-proxysql-multiplexing/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8a19d6c7d40c68078a482516c7c2a326ccb9f6e9282cabe7240ecc1a80c6cb47.css" integrity="sha256-ihnWx9QMaAeKSCUWx8KjJsy59ukoLKvnJA7MGoDGy0c=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/img/logo.gif">
<link rel="apple-touch-icon" href="http://localhost:1313/logo.gif">
<link rel="mask-icon" href="http://localhost:1313/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/2017/04/mysql-proxysql-multiplexing/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Sean&#39;s Note (Alt + H)">Sean&#39;s Note</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      ProxySQL之连接复用（multiplexing）以及相关问题说明
    </h1>
    <div class="post-meta"><span title='2017-04-17 21:32:49 +0000 UTC'>2017-04-17</span>&nbsp;·&nbsp;10 min

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e4%b8%b4%e6%97%b6%e8%a1%a8%e4%b8%8e%e7%94%a8%e6%88%b7%e5%8f%98%e9%87%8f%e9%aa%8c%e8%af%81-1-2" aria-label="1. 临时表与用户变量（验证 1, 2）">1. 临时表与用户变量（验证 1, 2）</a></li>
                    <li>
                        <a href="#2-%e6%98%be%e5%bc%8fstart-transaction-%e9%aa%8c%e8%af%813" aria-label="2. 显式start transaction (验证3)">2. 显式start transaction (验证3)</a></li>
                    <li>
                        <a href="#31-autocommit-%e4%bc%9a%e8%af%9d%e5%8f%98%e9%87%8f-%e9%aa%8c%e8%af%814" aria-label="3.1 autocommit 会话变量 (验证4)">3.1 autocommit 会话变量 (验证4)</a></li>
                    <li>
                        <a href="#32-%e5%ad%97%e7%ac%a6%e9%9b%86prepared%e4%bc%9a%e8%af%9d%e5%8f%98%e9%87%8f-%e9%aa%8c%e8%af%814" aria-label="3.2 字符集prepared会话变量 (验证4)">3.2 字符集prepared会话变量 (验证4)</a></li>
                    <li>
                        <a href="#33-set-sql_mode" aria-label="3.3 set sql_mode">3.3 set sql_mode</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><p>ProxySQL在连接池(<em>persistent connection poll</em>)的基础上，还有一个连接复用的概念 <em>multiplexing connection</em>，官方的wiki里没有很明确的说明，但在作者的一些 blog post 和 issue 里能找到解答： <a href="https://github.com/sysown/proxysql/issues/939#issuecomment-287489317">https://github.com/sysown/proxysql/issues/939#issuecomment-287489317</a></p>
<p>由于SQL可以路由，一个客户端连接上来，可能会到多个 hostgroup 发起连接。复用的意思是，一个后端DB的连接，可以“同时”被多个客户端使用。</p>
<p>传统的连接池，会在客户端<strong>断开连接</strong>（会话）后，把连接放回到池里。在ProxySQL中，由于连接复用，连接会在<strong>sql语句</strong>执行结束后，便将连接放回到池里（客户端会话可能并没有断开），这样便可大大提高后端连接的使用效率，而避免前段请求过大导致后端连接数疯长。</p>
<p>但这样做有时候并不安全，比如应用端连接时指定了 <code>set NAMES xxx</code>，然后执行查询，那么由于multiplexing可能导致两个语句发到不同的DB上执行，继而没有按照预期的字符集执行。proxysql考虑到了这种情况：</p>
<ol>
<li>连接会话里创建了临时表，<code>CREATE TEMPORARY table xxxx...</code></li>
<li>select @开头的变量，如<code>select @@hostname</code></li>
<li>手动开启了事务，<code>start transaction</code>, <code>commit</code>, <code>rollback</code>等等</li>
<li>连接设置了自己的用户变量，比如<code>set names xxx</code>, <code>set autocommit x</code>, <code>set sql_mode=xxx</code>, <code>set v_uservar=xx</code>等等</li>
</ol>
<p>第1,2,3点会根据路由规则，会自动禁用multiplex，发到对应hostgroup后，连接未断开之前不会复用到其它客户端。具体是发到主库还是从库，与匹配的规则有关。
issue <a href="https://github.com/sysown/proxysql/issues/941">#941</a> 和 <a href="https://github.com/sysown/proxysql/issues/917">#917</a> 都有提到临时表丢失的问题，可以用不同的rule来避免</p>
<p>下面对上面几点一一说明。</p>
<h2 id="1-临时表与用户变量验证-1-2">1. 临时表与用户变量（验证 1, 2）<a hidden class="anchor" aria-hidden="true" href="#1-临时表与用户变量验证-1-2">#</a></h2>
<p>以下注意连接的会话窗口及执行顺序，admin打头的是在proxysql管理接口上执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- [session 1] mysql client proxysql
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; select 1;
</span></span><span class="line"><span class="cl">+---+
</span></span><span class="line"><span class="cl">| 1 |
</span></span><span class="line"><span class="cl">+---+
</span></span><span class="line"><span class="cl">| 1 |
</span></span><span class="line"><span class="cl">+---+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 2] proxysql admin cli
</span></span><span class="line"><span class="cl">select * from stats_mysql_processlist;
</span></span><span class="line"><span class="cl">Empty set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">普通查询，session 1 没断开，但后端连接已放回连接池，所以看不到processlist。下面试验临时表：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 1] mysql client proxysql
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; CREATE TEMPORARY TABLE db0.tbl_tmp(id int);
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.18 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 2] proxysql admin cli
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select * from stats_mysql_processlist;
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| ThreadID | SessionID | user  | db                 | cli_host    | cli_port | hostgroup | l_srv_host  | l_srv_port | srv_host     | srv_port | command | time_ms | info |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| 0        | 60        | ecdba | information_schema | 10.0.100.34 | 27058    | 100       | 10.0.100.36 | 41245      | 10.0.100.100 | 3307     | Sleep   | 4506    |      |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">看到后端的连接没有释放回连接池，但是在 session 1 里select却看不到刚才创建的临时表：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 1] 
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; select * from db0.tbl_tmp;
</span></span><span class="line"><span class="cl">ERROR 1146 (42S02): Table &#39;db0.tbl_tmp&#39; doesn&#39;t exist
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 2] 
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select * from stats_mysql_processlist;
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+------------+------------+----------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| ThreadID | SessionID | user  | db                 | cli_host    | cli_port | hostgroup | l_srv_host | l_srv_port | srv_host | srv_port | command | time_ms | info |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+------------+------------+----------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| 0        | 60        | ecdba | information_schema | 10.0.100.34 | 27058    | 1000      |            |            |          |          | Sleep   | 2002    |      |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+------------+------------+----------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">select之后，发现上面的srv_host为空。下面往临时表里插数据，正常，且连接被 session 1 客户端持有：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 1] 
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; insert into db0.tbl_tmp values(1);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.01 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 2] 
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select * from stats_mysql_processlist;
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| ThreadID | SessionID | user  | db                 | cli_host    | cli_port | hostgroup | l_srv_host  | l_srv_port | srv_host     | srv_port | command | time_ms | info |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| 0        | 60        | ecdba | information_schema | 10.0.100.34 | 27058    | 100       | 10.0.100.36 | 41245      | 10.0.100.100 | 3307     | Sleep   | 2996    |      |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 1] 
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; select 1;
</span></span><span class="line"><span class="cl">+---+
</span></span><span class="line"><span class="cl">| 1 |
</span></span><span class="line"><span class="cl">+---+
</span></span><span class="line"><span class="cl">| 1 |
</span></span><span class="line"><span class="cl">+---+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 2] 
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select * from stats_mysql_processlist;
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+------------+------------+----------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| ThreadID | SessionID | user  | db                 | cli_host    | cli_port | hostgroup | l_srv_host | l_srv_port | srv_host | srv_port | command | time_ms | info |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+------------+------------+----------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| 0        | 60        | ecdba | information_schema | 10.0.100.34 | 27058    | 1000      |            |            |          |          | Sleep   | 2303    |      |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+------------+------------+----------+----------+---------+---------+------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过上面的过程可以看见，proxysql在遇到与会话本身相关的变量或操作时，自动禁用了multiplexing，并且针对整个会话有效，直到断开连接。另外，禁用了multiplexing，但<strong>路由规则依然生效</strong>，这就导致了select临时表时路由到了其它实例， Table xxx doesn&rsquo;t exist。</p>
<h2 id="2-显式start-transaction-验证3">2. 显式start transaction (验证3)<a hidden class="anchor" aria-hidden="true" href="#2-显式start-transaction-验证3">#</a></h2>
<p>第1,2点根据开发的习惯，都可以避免使用，但显式事务有时却不得不用，也做一个测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">为了效果明显，我将一个不相干的实例，分配同一个</span><span class="n">hostgroup_id</span><span class="err">，权重</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">1</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">fid</span> <span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">corpid</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>      <span class="mi">0</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>     <span class="mi">16</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>     <span class="mi">32</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ERROR</span> <span class="mi">1146</span> <span class="p">(</span><span class="mi">42</span><span class="n">S02</span><span class="p">):</span> <span class="n">Table</span> <span class="s1">&#39;db0.tbl_0&#39;</span> <span class="n">doesn</span><span class="s1">&#39;t exist</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>  <span class="o">--</span> <span class="err">开启一个事务</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">fid</span> <span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">corpid</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>      <span class="mi">0</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>     <span class="mi">16</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>     <span class="mi">32</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ERROR</span> <span class="mi">1146</span> <span class="p">(</span><span class="mi">42</span><span class="n">S02</span><span class="p">):</span> <span class="n">Table</span> <span class="s1">&#39;db0.tbl_0&#39;</span> <span class="n">doesn</span><span class="s1">&#39;t exist</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">这就尴尬了，明显是在同一个事务里面，后端依然请求了多个</span><span class="n">backend</span><span class="err">。设置</span> <span class="n">transaction_persistent</span> <span class="err">：</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">2</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">update</span> <span class="n">mysql_users</span> <span class="n">set</span> <span class="n">transaction_persistent</span><span class="o">=</span><span class="mi">1</span> <span class="n">where</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;ecdba&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="nb">load</span> <span class="n">mysql</span> <span class="n">users</span> <span class="n">to</span> <span class="n">run</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">1</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">fid</span> <span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">corpid</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>      <span class="mi">0</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>     <span class="mi">16</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>   <span class="o">|</span>     <span class="mi">32</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------+--------+</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">反复执行多次还是上面的结果。</span> <span class="err">看到到后端连接的情况：</span>
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">2</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">stats_mysql_processlist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">ThreadID</span> <span class="o">|</span> <span class="n">SessionID</span> <span class="o">|</span> <span class="n">user</span>  <span class="o">|</span> <span class="n">db</span>                 <span class="o">|</span> <span class="n">cli_host</span>    <span class="o">|</span> <span class="n">cli_port</span> <span class="o">|</span> <span class="n">hostgroup</span> <span class="o">|</span> <span class="n">l_srv_host</span>  <span class="o">|</span> <span class="n">l_srv_port</span> <span class="o">|</span> <span class="n">srv_host</span>     <span class="o">|</span> <span class="n">srv_port</span> <span class="o">|</span> <span class="n">command</span> <span class="o">|</span> <span class="n">time_ms</span> <span class="o">|</span> <span class="n">info</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">3</span>        <span class="o">|</span> <span class="mi">73</span>        <span class="o">|</span> <span class="n">ecdba</span> <span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">100.34</span> <span class="o">|</span> <span class="mi">45030</span>    <span class="o">|</span> <span class="mi">100</span>       <span class="o">|</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span> <span class="o">|</span> <span class="mi">6057</span>       <span class="o">|</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">100.100</span> <span class="o">|</span> <span class="mi">3307</span>     <span class="o">|</span> <span class="n">Sleep</span>   <span class="o">|</span> <span class="mi">43046</span>   <span class="o">|</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+--------------+----------+---------+---------+------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看到用户的 <code>transaction_persistent</code> 属性可以保证在同一个事务内的所有sql，都发向后端同一个db实例。如果它为0，同时一个hostgroup有多个可用slave，可能由于不同从库的延迟不一样，而查到不一致的数据。</p>
<p><code>transaction_persistent=1</code> 时还注意一下隐藏的一点点细节，begin 开启事务后，事务内所有语句包括select，都路由到了主库，这是因为 begin 匹配规则选择的是主库，后续的查询都跟着走;而 <code>transaction_persistent=0</code> 时 bgein 由于路由规则作用，也发到了主库，但后续的select,update等是不受它约束，继续根据路由规则走。在 非 <em>master-master</em> 模式下，事务还是安全的。</p>
<h2 id="31-autocommit-会话变量-验证4">3.1 autocommit 会话变量 (验证4)<a hidden class="anchor" aria-hidden="true" href="#31-autocommit-会话变量-验证4">#</a></h2>
<p>第 4 点略微有些复杂，开始之前先引用一段作者针对 issue <a href="https://github.com/sysown/proxysql/issues/653#issuecomment-241828093">#653</a> 的回复：（不完全翻译）</p>
<blockquote>
<p><strong>ProxySQL doesn&rsquo;t track user variable</strong><br>
ProxySQL不会记录 用户变量，当proxysql识别到 <code>set @variable1 = 67</code> 语句时，会自动禁用连接复用(disable multiplexing)，并根据路由规则选择后端节点（通常是写节点），执行完成后，连接不会放回连接池，直到disconnect。</p>
<p><strong>ProxySQL tracks some session variables</strong><br>
ProxySQL会记录 会话变量，“记录” 的意思是，proxysql接收到这些会话变量后，不会马上从后端连接池去拿连接然后 set xxx （因为还没有足够的信息知道拿哪个用户哪个db的连接），而是在当前连接保存起来，等待下一个查询命令，然后一起发送到到后端。<code>use dbname</code>就是这样处理的。
当前，记录的只有 <code>autocommit</code> 和字符集变量、<code>timezone</code>。比如执行sql前发送一个 <code>set autocommit=1</code>，proxysql会马上返回一个 <code>OK</code>，代表它知道应用端设置了自动提交，等真正的dml请求过来时，它将与后端拿到的连接比较autocommit是否匹配，不匹配则先set再执行dml。</p>
<p>当然现实还受到proxysql全局变量 <code>mysql-enforce_autocommit_on_reads</code> 的影响，即是否开启对读操作强制 autocommit。这个变量所解决的问题是，在同一个事务里既有 write 又有 read 且配置了读写分离的情况下，会导致在 读库 和 写库 各自开一个事务 (从库会set autocommit=0)，这就不合理了，所以把它设为 true 可以保证事务始终是一个。默认 false。
但是如上节所说，如果开启了 <code>transaction_persistent=1</code>，这个问题就不存在了。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">1</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="err">@</span><span class="n">variable1</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">2</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">processlist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------+-------+--------------------+-----------+---------+---------+------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">SessionID</span> <span class="o">|</span> <span class="n">user</span>  <span class="o">|</span> <span class="n">db</span>                 <span class="o">|</span> <span class="n">hostgroup</span> <span class="o">|</span> <span class="n">command</span> <span class="o">|</span> <span class="n">time_ms</span> <span class="o">|</span> <span class="n">info</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------+-------+--------------------+-----------+---------+---------+------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">79</span>        <span class="o">|</span> <span class="n">ecdba</span> <span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span> <span class="mi">100</span>       <span class="o">|</span> <span class="n">Sleep</span>   <span class="o">|</span> <span class="mi">8008</span>    <span class="o">|</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------+-------+--------------------+-----------+---------+---------+------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">与后端的连接已建立。但如果没有路由规则匹配到，</span><span class="n">proxysql会选择该用户</span> <span class="n">default_hostgroup</span><span class="err">，一般是</span><span class="mi">0</span><span class="err">，由于没有</span> <span class="n">HG</span> <span class="mi">0</span> <span class="err">记录，这个</span><span class="n">set</span> <span class="n">variables会失败</span><span class="err">：</span>
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">1</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="err">@</span><span class="n">variable1</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ERROR</span> <span class="mi">9001</span> <span class="p">(</span><span class="n">HY000</span><span class="p">):</span> <span class="n">Max</span> <span class="n">connect</span> <span class="n">timeout</span> <span class="n">reached</span> <span class="k">while</span> <span class="n">reaching</span> <span class="n">hostgroup</span> <span class="mi">0</span> <span class="n">after</span> <span class="mi">11462</span><span class="n">ms</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">同样情况下，</span><span class="n">set</span> <span class="n">autocommit</span> <span class="err">和</span> <span class="n">set</span> <span class="n">names</span> <span class="err">就很快返回，并且看不到后端有连接：</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">session</span> <span class="n">transaction</span> <span class="n">isolation</span> <span class="n">level</span> <span class="n">read</span> <span class="n">committed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">autocommit</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">2</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">processlist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Empty</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="p">[</span><span class="n">session</span> <span class="mi">1</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="n">begin开启一个事务</span><span class="err">，验证</span> <span class="n">transaction_persistent</span><span class="err">：</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">UPDATE</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span> <span class="n">set</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;db0 autocommit&#39;</span> <span class="n">where</span> <span class="n">fid</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Rows</span> <span class="n">matched</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">Changed</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">Warnings</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">fid</span> <span class="o">|</span> <span class="n">username</span>       <span class="o">|</span> <span class="n">corpid</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>         <span class="o">|</span>      <span class="mi">0</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">aa</span>         <span class="o">|</span>     <span class="mi">16</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span> <span class="n">db0</span> <span class="n">autocommit</span> <span class="o">|</span>     <span class="mi">32</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+----------------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">commit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">查看后端</span><span class="n">DB</span><span class="err">（主库）的</span> <span class="n">general_log</span><span class="err">：（都发到了主库）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="mi">9651978</span> <span class="n">Connect</span>	<span class="n">ecdba</span><span class="err">@</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">100.36</span> <span class="n">on</span> <span class="n">information_schema</span>
</span></span><span class="line"><span class="cl">		<span class="mi">9651978</span> <span class="n">Query</span>	<span class="n">SET</span> <span class="n">autocommit</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">		<span class="mi">9651978</span> <span class="n">Query</span>	<span class="n">UPDATE</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span> <span class="n">set</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;db0 autocommit&#39;</span> <span class="n">where</span> <span class="n">fid</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">		<span class="mi">9651978</span> <span class="n">Query</span>	<span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">db0</span><span class="o">.</span><span class="n">tbl_0</span>
</span></span><span class="line"><span class="cl">		<span class="mi">9651978</span> <span class="n">Query</span>	<span class="n">commit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这也告诉我们，尽量不要在 proxy admin cli 里面执行 show slave status， set global xxx 这样的管理命令，你较难预知到后端在哪里执行的。</p>
<h2 id="32-字符集prepared会话变量-验证4">3.2 字符集prepared会话变量 (验证4)<a hidden class="anchor" aria-hidden="true" href="#32-字符集prepared会话变量-验证4">#</a></h2>
<p>对字符集 <code>set NAMES xxx</code>, <code>set character_set_client=xxx</code>，处理方法与上面 set autocommit 是一样的，但是遇到使用 prepared statement 时需要特别提一下。</p>
<p>首先ProxySQL所支持的字符集，在表 <em>mysql_collations</em> 可以看到，它是直接从本地安装的mysql client lib获取的，proxysql默认使用的是utf8，指的是在连接的时候默认认为客户端的字符集是utf8。</p>
<p>根据 issue #780：https://github.com/sysown/proxysql/issues/780 的讨论，某些框架比如 Laravel 在通过PDO连接MySQL时，执行 prepared statement时会连同 <code>set NAMES xx</code> 一起发送，导致没有生效。经测试，该问题在 v1.3.5 中已不存在：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- [session 1] 
</span></span><span class="line"><span class="cl">mysql -uecweb -pweber -h10.0.100.34 -P6033 --default-character-set=latin1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(ecweb@10.0.100.34:6033) [(none)]&gt; select * from d_ec_crm.tttt;
</span></span><span class="line"><span class="cl">+-----+-------+
</span></span><span class="line"><span class="cl">| fid | fname |
</span></span><span class="line"><span class="cl">+-----+-------+
</span></span><span class="line"><span class="cl">|   1 | xx??? |
</span></span><span class="line"><span class="cl">+-----+-------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> latin1连接看utf8的数据，所以乱码。下面模拟 prepared statement 设置字符集：
</span></span><span class="line"><span class="cl">(ecweb@10.0.100.34:6033) [(none)]&gt; PREPARE stmt FROM &#39;SET NAMES utf8&#39;;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">Statement prepared
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [session 2] 
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select * from stats_mysql_processlist;
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+---------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| ThreadID | SessionID | user  | db                 | cli_host    | cli_port | hostgroup | l_srv_host  | l_srv_port | srv_host      | srv_port | command | time_ms | info |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+---------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">| 1        | 50        | ecweb | information_schema | 10.0.100.34 | 46389    | 110       | 10.0.100.34 | 31946      | 192.168.1.229 | 3307     | Sleep   | 35649   |      |
</span></span><span class="line"><span class="cl">+----------+-----------+-------+--------------------+-------------+----------+-----------+-------------+------------+---------------+----------+---------+---------+------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">直接执行还是乱码，也要在prepared ：
</span></span><span class="line"><span class="cl">(ecweb@10.0.100.34:6033) [(none)]&gt; select * from d_ec_crm.tttt;
</span></span><span class="line"><span class="cl">+-----+-------+
</span></span><span class="line"><span class="cl">| fid | fname |
</span></span><span class="line"><span class="cl">+-----+-------+
</span></span><span class="line"><span class="cl">|   1 | xx??? |
</span></span><span class="line"><span class="cl">+-----+-------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(ecweb@10.0.100.34:6033) [(none)]&gt; PREPARE stmt FROM &#39;select * from d_ec_crm.tttt&#39;;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">Statement prepared
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(ecweb@10.0.100.34:6033) [(none)]&gt; EXECUTE stmt;
</span></span><span class="line"><span class="cl">+-----+-------------+
</span></span><span class="line"><span class="cl">| fid | fname       |
</span></span><span class="line"><span class="cl">+-----+-------------+
</span></span><span class="line"><span class="cl">|   1 | xx嘻嘻嘻 |
</span></span><span class="line"><span class="cl">+-----+-------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到 <code>PREPARE stmt FROM 'SET NAMES utf8'</code> 发送之后，马上与后端建立了连接，而不像上节<code>set names xx</code>止步于proxysql。所以是自动禁用了 multiplexing。</p>
<h2 id="33-set-sql_mode">3.3 set sql_mode<a hidden class="anchor" aria-hidden="true" href="#33-set-sql_mode">#</a></h2>
<p>作者明确表示 <code>sql_mode</code> 在 1.3.x 版本里不会track，也就是它完全按照路由规则走，不会像临时表或用户变量那样 disable multiplexing automaticly，也不像上面的会话变量那样 “记录” 然后一并发送。</p>
<p>如果sql_mode确实对应用使用造成困扰，1.4版本里会修复，在此前估计只好将连接复用的特性全局禁用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SET mysql-multiplexing=&#39;false&#39;;
</span></span><span class="line"><span class="cl">LOAD MYSQL VARIABLES TO RUNTIME;
</span></span><span class="line"><span class="cl">SAVE MYSQL VARIABLES TO DISK;
</span></span></code></pre></td></tr></table>
</div>
</div><p>参考 <a href="https://github.com/sysown/proxysql/issues/916">issue #916</a>。禁用 multiplexing 后，就像一般的中间件连接池一样，维持或者释放连接。</p>
<p>最后，关于 multiplexing 向作者提了一个特性 <a href="https://github.com/sysown/proxysql/issues/594#issuecomment-294703577">594#issuecomment-294703577</a> ：前端连接执行完一个查询，后端不马上把它返回连接池（复用），而是等待几秒，如果这个连接后续又有sql进来，就不需要重新从池里获取连接，还有检查一堆变量。renecannao 的回复非常及时，也确认 v1.4 会加上这个功能。</p>
<p>updated at 2017-07-27:
关于连接复用与连接池的差别，在后一次与作者的沟通中，更加明确了，见 <a href="https://github.com/sysown/proxysql/issues/1107">#issue 1107</a>:
问题始于发现环境中的connection pool没有起作用（禁用了multiplexing），因为一开始只是认为禁用了multiplexing，connection pool不会受影响。但实际不是的，在1.3.x版本里，禁用multiplexing，就相当于连接复用和连接池都没有了，前端应用在释放连接后，proxysql也把后端的连接释放了；在1.4.x版本里表现不同，禁用multiplexing后，前端连接释放，proxysql对后端的连接继续保持，并对连接重置以便重复利用。</p>
<p>所以如果测试上没啥问题，建议开启连接复用，或者升级到 1.4.x 版本。</p>
<hr>
<p>原文连接地址：http://xgknight.com/2017/04/17/mysql-proxysql-multiplexing/</p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/mysql/">Mysql</a></li>
      <li><a href="http://localhost:1313/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li>
      <li><a href="http://localhost:1313/tags/proxysql/">Proxysql</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/2017/04/mysql-proxysql-performance-test/">
    <span class="title">« Prev</span>
    <br>
    <span>ProxySQL之性能测试对比</span>
  </a>
  <a class="next" href="http://localhost:1313/2017/04/mysql-proxysql-route-rw_split/">
    <span class="title">Next »</span>
    <br>
    <span>ProxySQL之读写分离与分库路由演示</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
        repo="seanlook/sean-notes-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Sean&#39;s Note</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
