<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>生产环境使用 pt-table-checksum 检查MySQL数据一致性 | Sean&#39;s Note</title>
<meta name="keywords" content="mysql, 主从复制, percona">
<meta name="description" content="公司数据中心从托管机房迁移到阿里云，需要对mysql迁移（Replication）后的数据一致性进行校验，但又不能对生产环境使用造成影响，pt-table-checksum 成为了绝佳也是唯一的检查工具。">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/2015/12/mysql_replica_pt-table-checksum/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8a19d6c7d40c68078a482516c7c2a326ccb9f6e9282cabe7240ecc1a80c6cb47.css" integrity="sha256-ihnWx9QMaAeKSCUWx8KjJsy59ukoLKvnJA7MGoDGy0c=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/img/logo.gif">
<link rel="apple-touch-icon" href="http://localhost:1313/logo.gif">
<link rel="mask-icon" href="http://localhost:1313/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/2015/12/mysql_replica_pt-table-checksum/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Sean&#39;s Note (Alt + H)">Sean&#39;s Note</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      生产环境使用 pt-table-checksum 检查MySQL数据一致性
    </h1>
    <div class="post-meta"><span title='2015-12-29 10:21:25 +0000 UTC'>2015-12-29</span>&nbsp;·&nbsp;10 min

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%b7%a5%e4%bd%9c%e8%bf%87%e7%a8%8b" aria-label="工作过程">工作过程</a></li>
                    <li>
                        <a href="#%e4%bd%a0%e9%9c%80%e8%a6%81%e7%9f%a5%e9%81%93%e7%9a%84%e9%80%89%e9%a1%b9" aria-label="你需要知道的选项">你需要知道的选项</a></li>
                    <li>
                        <a href="#%e6%a3%80%e6%b5%8b%e5%ae%9e%e4%be%8b" aria-label="检测实例">检测实例</a><ul>
                            
                    <li>
                        <a href="#%e5%90%8c%e7%bd%91%e6%ae%b5%e9%97%b4%e4%b8%bb%e4%bb%8e%e4%b8%80%e8%87%b4%e6%a3%80%e6%9f%a5" aria-label="同网段间主从一致检查">同网段间主从一致检查</a></li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8dsn%e8%b7%a8%e6%95%b0%e6%8d%ae%e4%b8%ad%e5%bf%83%e6%a3%80%e6%b5%8b" aria-label="使用dsn跨数据中心检测">使用dsn跨数据中心检测</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b8%b8%e8%a7%81%e9%94%99%e8%af%af" aria-label="常见错误">常见错误</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><p>公司数据中心从托管机房迁移到阿里云，需要对mysql迁移（Replication）后的数据一致性进行校验，但又不能对生产环境使用造成影响，pt-table-checksum 成为了绝佳也是唯一的检查工具。</p>
<p><code>pt-table-checksum</code> 是 Percona-Toolkit 的组件之一，用于检测MySQL主、从库的数据是否一致。其原理是在主库执行基于statement的sql语句来生成主库数据块的checksum，把相同的sql语句传递到从库执行，并在从库上计算相同数据块的checksum，最后，比较主从库上相同数据块的checksum值，由此判断主从数据是否一致。检测过程根据唯一索引将表按row切分为块（chunk），以为单位计算，可以避免锁表。检测时会自动判断复制延迟、 master的负载， 超过阀值后会自动将检测暂停，减小对线上服务的影响。</p>
<p><code>pt-table-checksum</code> 默认情况下可以应对绝大部分场景，官方说，即使上千个库、上万亿的行，它依然可以很好的工作，这源自于设计很简单，一次检查一个表，不需要太多的内存和多余的操作；必要时，<code>pt-table-checksum</code> 会根据服务器负载动态改变 chunk 大小，减少从库的延迟。</p>
<p>为了减少对数据库的干预，<code>pt-table-checksum</code>还会自动侦测并连接到从库，当然如果失败，可以指定<code>--recursion-method</code>选项来告诉从库在哪里。它的易用性还体现在，复制若有延迟，在从库 checksum 会暂停直到赶上主库的计算时间点（也通过选项<code>--</code>设定一个可容忍的延迟最大值，超过这个值也认为不一致）。</p>
<p>为了保证主数据库服务的安全，该工具实现了许多保护措施：</p>
<ol>
<li>自动设置 <code>innodb_lock_wait_timeout</code> 为1s，避免引起</li>
<li>默认当数据库有25个以上的并发查询时，<code>pt-table-checksum</code>会暂停。可以设置 <code>--max-load</code> 选项来设置这个阀值</li>
<li>当用 Ctrl+C 停止任务后，工具会正常的完成当前 chunk 检测，下次使用 <code>--resume</code> 选项启动可以恢复继续下一个 chunk</li>
</ol>
<h2 id="工作过程">工作过程<a hidden class="anchor" aria-hidden="true" href="#工作过程">#</a></h2>
<p>直接看 <a href="http://www.nettedfish.com/blog/2013/06/04/check-replication-consistency-by-pt-table-checksum/">nettedfish</a> 的说明：</p>
<blockquote>
</blockquote>
<p>1. 连接到主库：pt工具连接到主库，然后自动发现主库的所有从库。默认采用show full processlist来查找从库，但是这只有在主从实例端口相同的情况下才有效。
3. 查找主库或者从库是否有复制过滤规则：这是为了安全而默认检查的选项。你可以关闭这个检查，但是这可能导致checksum的sql语句要么不会同步到从库，要么到了从库发现从库没有要被checksum的表，这都会导致从库同步卡库。
5. 开始获取表，一个个的计算。
6. 如果是表的第一个chunk，那么chunk-size一般为1000；如果不是表的第一个chunk，那么采用19步中分析出的结果。
7. 检查表结构，进行数据类型转换等，生成checksum的sql语句。
8. 根据表上的索引和数据的分布，选择最合适的split表的方法。
9. 开始checksum表。
10. 默认在chunk一个表之前，先删除上次这个表相关的计算结果。除非–resume。
14. 根据explain的结果，判断chunk的size是否超过了你定义的chunk-size的上限。如果超过了，为了不影响线上性能，这个chunk将被忽略。
15. 把要checksum的行加上for update锁，并计算。
17-18. 把计算结果存储到master_crc master_count列中。
19. 调整下一个chunk的大小。
20. 等待从库追上主库。如果没有延迟备份的从库在运行，最好检查所有的从库，如果发现延迟最大的从库延迟超过max-lag秒，pt工具在这里将暂停。
21. 如果发现主库的max-load超过某个阈值，pt工具在这里将暂停。
22. 继续下一个chunk，直到这个table被chunk完毕。
23-24. 等待从库执行完checksum，便于生成汇总的统计结果。每个表汇总并统计一次。
25-26. 循环每个表，直到结束。
校验结束后，在每个从库上，执行如下的sql语句即可看到是否有主从不一致发生：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    select * from percona.checksums where master_cnt &lt;&gt; this_cnt OR master_crc &lt;&gt; this_crc OR 
</span></span><span class="line"><span class="cl">    ISNULL(master_crc) &lt;&gt; ISNULL(this_crc) \G
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="你需要知道的选项">你需要知道的选项<a hidden class="anchor" aria-hidden="true" href="#你需要知道的选项">#</a></h2>
<ul>
<li>
<p><code>--replicate-check</code>：执行完 checksum 查询在percona.checksums表中，不一定马上查看结果呀 —— yes则马上比较chunk的crc32值并输出DIFFS列，否则不输出。默认yes，如果指定为<code>--noreplicate-check</code>，一般后续使用下面的<code>--replicate-check-only</code>去输出DIFF结果。</p>
</li>
<li>
<p><code>--replicate-check-only</code>：不在主从库做 checksum 查询，只在原有 <code>percona.checksums</code> 表中查询结果，并输出数据不一致的信息。周期性的检测一致性时可能用到。</p>
</li>
<li>
<p><code>--nocheck-binlog-format</code>：不检测日志格式。这个选项对于 ROW 模式的复制很重要，因为<code>pt-table-checksum</code>会在 Master和Slave 上设置<code>binlog_format=STATEMENT</code>（确保从库也会执行 checksum SQL），MySQL限制从库是无法设置的，所以假如行复制从库，再作为主库复制出新从库时（A-&gt;B-&gt;C），B的checksums数据将无法传输。（没验证）</p>
</li>
<li>
<p><code>--replicate=</code> 指定 checksum 计算结果存到哪个库表里，如果没有指定，默认是 percona.checksums 。
但是我们检查使用的mysql用户一般是没有 create table 权限的，所以你可能需要先手动创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CREATE DATABASE IF NOT EXISTS percona;
</span></span><span class="line"><span class="cl">CREATE TABLE IF NOT EXISTS percona.checksums (
</span></span><span class="line"><span class="cl">    db CHAR(64) NOT NULL,
</span></span><span class="line"><span class="cl">    tbl CHAR(64) NOT NULL,
</span></span><span class="line"><span class="cl">    chunk INT NOT NULL,
</span></span><span class="line"><span class="cl">    chunk_time FLOAT NULL,
</span></span><span class="line"><span class="cl">    chunk_index VARCHAR(200) NULL,
</span></span><span class="line"><span class="cl">    lower_boundary TEXT NULL,
</span></span><span class="line"><span class="cl">    upper_boundary TEXT NULL,
</span></span><span class="line"><span class="cl">    this_crc CHAR(40) NOT NULL,
</span></span><span class="line"><span class="cl">    this_cnt INT NOT NULL,
</span></span><span class="line"><span class="cl">    master_crc CHAR(40) NULL,
</span></span><span class="line"><span class="cl">    master_cnt INT NULL,
</span></span><span class="line"><span class="cl">    ts TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (db,tbl,chunk),
</span></span><span class="line"><span class="cl">    INDEX ts_db_tbl(ts,db,tbl)
</span></span><span class="line"><span class="cl">) ENGINE=InnoDB;
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>生产环境中数据库用户权限一般都是有严格管理的，假如连接用户是<code>repl_user</code>（即直接用复制用户来检查），它应该额外赋予对其它库的 SELECT ，LOCK TABLES 权限，如果后续要用 pt-table-sync 就就需要写权限了。对percona库有写权限：</p>
<pre><code>    GRANT ALL PRIVILEGEES on percona.* to repl_user@'%' IDENTIFIED BY 'repl_pass';
    GRANT SELECT,LOCK TABLES,PROCESS,SUPER on *.* to repl_user@'%';
</code></pre>
<p>注：</p>
<ol>
<li>为了减少不必要的麻烦，确保你的 repl_user@&lsquo;xxx&rsquo; 用户能同时登陆主库和从库</li>
<li><code>--create-replicate-table</code> 选项会自动创建 percona.checksums 表，但也意味着赋予额外的 <code>CREATE TABLE</code>权限给 percona_tk@&lsquo;xxx&rsquo; 用户。默认yes</li>
<li>PROCESS用于自动发现从库信息，SUPER权限用于set binlog_format。</li>
</ol>
<ul>
<li>
<p><code>--no-check-replication-filters</code> 表示不需要检查 Master 配置里是否指定了 Filter。 默认会检查，如果配置了 Filter，如 replicate_do_db,replicate-wild-ignore-table,binlog_ignore_db 等，在从库checksum就与遇到表不存在而报错退出，所以官方默认是yes（<code>--check-replication-filters</code>）但我们实际在检测中时指定<code>--databases=</code>，所以就不存在这个问题，干脆不检测</p>
</li>
<li>
<p><code>--empty-replicate-table</code>：每个表checksum开始前，清空它之前的检测数据（不影响其它表的checksum数据），默认yes。当然如果使用<code>--resume</code>启动检测数据不会清空。
当启用<code>--noempty-replicate-table</code>即不清空时，不计算计算chunk,只计算。</p>
</li>
<li>
<p><code>--databases=</code>，<code>-d</code>：要检查的数据库，逗号分隔。用脚趾头想也知道 <code>--databases-regex</code> 正则匹配要检测的数据库，<code>--ignore-databases[-regex]</code>忽略检查的库。Filter选项。</p>
</li>
<li>
<p><code>--tables=</code>，<code>-t</code>：要检查的表，逗号分隔。如果要检查的表分布在不同的db中，可以用<code>--tables=dbname1.table1,dbnamd2.table2</code>的形式。同理有<code>--tables-regex</code>，<code>--ignore-tables</code>，<code>--ignore-tables-regex</code>。<code>--replicate</code>指定的checksum表始终会被过滤。</p>
</li>
<li>
<p><code>--recursion-method</code>：发现从库的方式。pt-table-checksum 默认可以在主库的 <code>processlist</code> 中找到从库复制进程，从而识别出有哪些从库，但如果使用是非标准3306端口，会导致找不到从库信息。此时就会自动采用<code>host</code>方式，但需要提前在从库 my.cnf 里面配置<code>report_host</code>、<code>report_port</code>信息，如：</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        report_host = MASTER_HOST
</span></span><span class="line"><span class="cl">        report_port = 13306
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终极的办法是<code>dsn</code>，dsn指定的是某个表（如 percona.dsns ），表行记录是改主库的（多个）从库的连接信息。适用以下任一情形：</p>
<ol>
<li>主库不能自动发现从库</li>
<li>不想在从库添加额外配置（因为要重启）</li>
<li>主从检测连接用户信息不一样</li>
<li>多个从库时只想验证指定从库的一致</li>
</ol>
<p>我比较倾向使用DSN的方式。这个dsns表只需要在执行 <code>pt-table-checksum</code> 命令的服务器上能够访问到就行。这里纠正一个认识，网上很多人说 pt-table-checksum 要在主库上执行，其实不是的，我的mysql实例比较多，只需在某一台服务器上安装percona-toolkit，这台服务能够同时访问主库和从库就行了。具体用法见后面实例。</p>
<h2 id="检测实例">检测实例<a hidden class="anchor" aria-hidden="true" href="#检测实例">#</a></h2>
<h3 id="同网段间主从一致检查">同网段间主从一致检查<a hidden class="anchor" aria-hidden="true" href="#同网段间主从一致检查">#</a></h3>
<p>场景：</p>
<ol>
<li>标准端口3306，只检查某一个库的关键表</li>
<li>一主一从，binlog<strong>不</strong>是ROW模式</li>
<li>同网段复制，percona_tk@&lsquo;192.168.5.%&rsquo; 具备该有的权限：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        GRANT ALL PRIVILEGEES on repl_user.* to repl_user@&#39;192.168.5.%&#39; IDENTIFIED BY &#39;repl_pass&#39;;
</span></span><span class="line"><span class="cl">        GRANT SELECT,LOCK TABLES,PROCESS,SUPER on *.* to repl_user@&#39;192.168.5.%&#39;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是最简单的方式，把要连接和检查的信息交代就行了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># pt-table-checksum h=MASTER_HOST,u=repl_user,p=&#39;repl_pass&#39;,P=3306 \
</span></span><span class="line"><span class="cl">--databases=d_ts_profile --tables=t_user,t_user_detail,t_user_group --nocheck-replication-filters
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果是首次运行，会在主库自动创建 percona.checksums 表。</p>
<p>输出结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Replica lag is 2307 seconds on mysql-5.  Waiting.
</span></span><span class="line"><span class="cl">Checksumming d_ts_profile.t_user_account:   3% 54:48 remain
</span></span><span class="line"><span class="cl">            TS ERRORS  DIFFS     ROWS  CHUNKS SKIPPED    TIME TABLE
</span></span><span class="line"><span class="cl">12-18T16:07:48      0      0   313641       9       0 146.417 d_ts_profile.t_user
</span></span><span class="line"><span class="cl">12-18T16:08:00      0      0   397734      12       0  11.747 d_ts_profile.t_user_detail
</span></span><span class="line"><span class="cl">12-18T16:08:24      0      0  1668327      20       0  23.941 d_ts_profile.t_user_group
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>TS ：完成检查的时间戳。</li>
<li>ERRORS ：检查时候发生错误和警告的数量。</li>
<li>DIFFS ：不一致的chunk数量。当指定 <code>--no-replicate-check</code> 即检查完但不立即输出结果时，会一直为0；当指定 <code>--replicate-check-only</code> 即不检查只从checksums表中计算crc32，且只显示不一致的信息（毕竟输出的大部分应该是一致的，容易造成干扰）。</li>
<li>ROWS ：比对的表行数。</li>
<li>CHUNKS ：被划分到表中的块的数目。</li>
<li>SKIPPED ：由于错误或警告或过大，则跳过块的数目。</li>
<li>TIME ：执行的时间。</li>
<li>TABLE ：被检查的表名</li>
</ul>
<h3 id="使用dsn跨数据中心检测">使用dsn跨数据中心检测<a hidden class="anchor" aria-hidden="true" href="#使用dsn跨数据中心检测">#</a></h3>
<p>场景：</p>
<ol>
<li>非标准端口13306，只检查以 d_ts 开头的所有库</li>
<li>一主二从，binlog<strong>是</strong>ROW模式，其中一从在阿里云ECS上，主库是无法直接访问该从库的</li>
<li>检测用的账号因为不是%，所以不一样</li>
<li>以下是我环境的情况
MASTER_HOST:13306 主库
REPLICA_HOST:3306    从库
PTCHECK_HOST pt-table-checksum所在服务器
DSN_DBHOST，记录从库（连接）dsns的数据库</li>
</ol>
<p>最优的方式就是dsn指定从库了。在从库或从库同网段主机里装上 percona-toolkit。</p>
<p>在DSN_DBHOST 数据库实例上创建DSNs表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">percona</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">percona</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">dsns</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="kp">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">parent_id</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">dsn</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">PRIVILEGEES</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">percona</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">percona_tk</span><span class="o">@</span><span class="s1">&#39;PTCHECK_HOST&#39;</span><span class="w"> </span><span class="k">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;percona_pass&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果有多个实例要检查，可以创建多个类似的dsns表。上面的percona_tk用户只是用来访问dsn库。插入从库信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">use percona;
</span></span><span class="line"><span class="cl">insert into dsns(dsn) values(&#39;h=REPLICA_HOST,P=3306,u=repl_user,p=repl_pass&#39;);
</span></span></code></pre></td></tr></table>
</div>
</div><p>DSNs记录 dsn 列格式如 <code>h=REPLICA_HOST,u=repl_user,p=repl_pass</code></p>
<p>在 PTCHECK_HOST 上执行检查命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># pt-table-checksum --replicate=percona.checksums --nocheck-replication-filters --no-check-binlog-format \
</span></span><span class="line"><span class="cl">h=MASTER_HOST,u=repl_user,p=&#39;repl_pass&#39;,P=13306 --databases-regex=d_ts.* \
</span></span><span class="line"><span class="cl">--recursion-method dsn=h=DSN_DBHOST,u=percona_tk,p=&#39;percona_pass&#39;,P=3306,D=percona,t=dsn
</span></span></code></pre></td></tr></table>
</div>
</div><p>选项的意思就不多说了。</p>
<p>检测完如果一致，其实是求个心安，特别是在做数据迁移的时候。如果不一致，那就需要借助 <code>pt-table-sync</code> 工具了，不作介绍。</p>
<h2 id="常见错误">常见错误<a hidden class="anchor" aria-hidden="true" href="#常见错误">#</a></h2>
<ol>
<li>
<p>Diffs cannot be detected because no slaves were found
不能自动找到从库，确认processlist或host或dsns方式用对了。</p>
</li>
<li>
<p>Cannot connect to h=slave1.***.com,p=&hellip;,u=percona_user
可以在<code>pt-table-checksum</code>命令前加<code>PTDEBUG=1</code>来看详细的执行过程，如端口、用户名、权限错误。</p>
</li>
<li>
<p>Waiting for the &ndash;replicate table to replicate to XXX
问题出在 percona.checksums 表在从库不存在，根本原因是没有从主库同步过来，所以看一下从库是否延迟严重。</p>
</li>
<li>
<p>Pausing because Threads_running=25
反复打印出类似上面停止检查的信息。这是因为当前数据库正在运行的线程数大于默认25，pt-table-checksum 为了减少对库的压力暂停检查了。等数据库压力过了就好了，或者也可以直接 Ctrl+C 终端，下一次加上<code>--resume</code>继续执行，或者加大<code>--max-load=</code>值。</p>
</li>
<li>
<p>字符集问题</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">Error</span><span class="w"> </span><span class="n">checksumming</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="n">query</span><span class="p">:</span><span class="w"> </span><span class="n">DBD</span><span class="p">::</span><span class="n">mysql</span><span class="p">::</span><span class="n">st</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">failed</span><span class="p">:</span><span class="w"> </span><span class="n">Illegal</span><span class="w"> </span><span class="n">mix</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">collations</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">12</span><span class="o">-</span><span class="mi">17</span><span class="n">T14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">04</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">checksumming</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">d_ec_cs</span><span class="p">.</span><span class="n">t_online_cs</span><span class="p">:</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="n">query</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">DBD</span><span class="p">::</span><span class="n">mysql</span><span class="p">::</span><span class="n">st</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">failed</span><span class="p">:</span><span class="w"> </span><span class="n">Illegal</span><span class="w"> </span><span class="n">mix</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">collations</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">operation</span><span class="w"> </span><span class="s1">&#39;concat_ws&#39;</span><span class="w"> </span><span class="p">[</span><span class="k">for</span><span class="w"> </span><span class="n">Statement</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="s2">&#34;REPLACE INTO `percona`.`ali_checksum` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT ?, ?, ?, ?, ?, ?, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS(&#39;#&#39;, `f_cs_id`, `f_corp_id`, `f_valid`, `f_show_name`, `f_online_msg`, `f_offline_msg`, `f_show_mobile`, `f_group_id`, `f_qq`, `f_show_qq`, `f_msn`, `f_show_msn`, `f_sms_online`, `f_scheme`, `f_tel`, `f_telno`, `f_show_tel`, `f_contact`, `f_mobile`, `f_position`, `f_other1`, `f_other2`, `f_other_text1`, `f_other_text2`, `f_email`, `f_qq_first`, `f_qq_first_type`, `f_aids_open`, `f_aids_qq`, `f_aids_crmqq`, `f_aids_yahoo`, `f_aids_skype`, `f_aids_aliww`, `f_aids_msn`, `f_aids_alibaba`, `f_aids_alitrade`, CONCAT(ISNULL(`f_show_name`), ISNULL(`f_group_id`), ISNULL(`f_qq`), ISNULL(`f_show_qq`), ISNULL(`f_sms_online`), ISNULL(`f_other_text1`), ISNULL(`f_other_text2`), ISNULL(`f_email`)) )) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `d_ec_cs`.`t_online_cs` 
</span></span></span><span class="line"><span class="cl"><span class="s2">/*checksum table*/&#34;</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">ParamValues</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">=</span><span class="s1">&#39;d_ts_profile&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="s1">&#39;t_user_account&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">=</span><span class="n">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">=</span><span class="n">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">=</span><span class="n">undef</span><span class="p">]</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="k">table</span><span class="o">-</span><span class="n">checksum</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">10520</span><span class="p">.</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>是个bug，暂时无法解决，<a href="https://bugs.launchpad.net/percona-toolkit/+bug/1427552">Illegal mix of collations for operation &lsquo;concat_ws&rsquo;</a>。</p>
<h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<ul>
<li><a href="https://www.percona.com/doc/percona-toolkit/2.2/pt-table-checksum.html">pt-table-checksum</a></li>
<li><a href="http://www.nettedfish.com/blog/2013/06/04/check-replication-consistency-by-pt-table-checksum/">用pt-table-checksum校验数据一致性</a></li>
<li><a href="http://blog.csdn.net/melody_mr/article/details/45224249">使用pt-table-checksum及pt-table-sync校验复制一致性详细介绍</a></li>
<li><a href="http://imysql.com/2015/04/19/mysql-faq-pt-table-checksum-use-case.shtml">Pausing because Threads_running=0</a></li>
</ul>
<hr>
<p>本文链接地址：http://xgknight.com/2015/12/29/mysql_replica_pt-table-checksum/</p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/mysql/">Mysql</a></li>
      <li><a href="http://localhost:1313/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">主从复制</a></li>
      <li><a href="http://localhost:1313/tags/percona/">Percona</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/2016/01/mac-mini-zturn/">
    <span class="title">« Prev</span>
    <br>
    <span>记一次Mac mini折腾过程（鼠键共享，更换SSD）</span>
  </a>
  <a class="next" href="http://localhost:1313/2015/12/mysql-replicas/">
    <span class="title">Next »</span>
    <br>
    <span>使用 Xtrabackup 在线对MySQL做主从复制</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
        repo="seanlook/sean-notes-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Sean&#39;s Note</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
